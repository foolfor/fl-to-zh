## 12.1 路由服务器模型说明

首先，我们将描述标准 BGP 扬声器内部 BGP 公告遭受的正常处理，[如图 12.1](https://www.quagga.net/docs/docs-multi/Description-of-the-Route-Server-model.html#fig_003anormal_002dprocessing)所示，它包括三个步骤：

- 当收到来自某个对等方的公告时，为该对等方配置的“In”过滤器将应用于该公告。这些过滤器可以拒绝通知、接受未修改的通知或接受其某些属性已修改的通知。
- 通过“In”过滤器的公告进入最佳路径选择过程，在此过程中将它们与从不同对等方接收到的指向同一目的地的其他公告进行比较（如果存在此类其他公告）。对于每个不同的目的地，被选为最佳的通告被插入到 BGP 发言者的 Loc-RIB 中。
- 插入到 Loc-RIB 中的路由会被考虑通告给所有对等体（除了路由来自的那个）。这是通过将 Loc-RIB 中的路由通过对应于每个对等体的“Out”过滤器来完成的。这些过滤器可以拒绝路由、接受未修改的路由，或者接受它的某些属性已修改。被对等方的“出”过滤器接受的那些路由被通告给该对等方。



当然，我们希望在使用路由服务器时与不使用路由服务器时在每个路由器中获得的路由表相同。但是由于具有单个 BGP 对等体（针对路由服务器），BGP 发言者无法再区分每个声明来自/向哪个对等体发出/到达/离开。 这意味着连接到路由服务器的路由器无法自行应用与全网状场景中相同的输入/输出过滤器，因此它们必须将这些功能委托给路由服务器。

更重要的是，还必须代表其客户端在路由服务器内部执行“最佳路径”选择。原因是，如果在应用了播音员和（潜在）接收者的过滤器之后，路由服务器决定向某个客户端发送两个或多个指向同一目的地的不同的播音，客户端将只保留最后一个，考虑到它作为对同一目的地的先前公告的隐含撤回。这是RFC1771 中定义的 BGP 发言者的预期行为，即使有一些机制建议允许通过单个 BGP 对等连接发送同一目的地的多条路径，但目前大多数现有 BGP 实现都不支持。

因此，路由服务器必须维护附加信息并为 RS 客户端执行普通 BGP 对等互连所需的附加任务。本质上，路由服务器必须：



- 为每个配置为 RS 客户端的对等端维护一个单独的路由信息库 (Loc-RIB)，其中包含作为代表该 RS 客户端执行的“最佳路径选择”过程的结果而选择的路由。

- 每当它收到来自 RS 客户端的通知时，它必须考虑其他 RS 客户端的 Loc-RIB。

  

  - 这意味着对于它们中的每一个，路由服务器都必须通过播音员的适当“输出”过滤器传递通知。
  - 然后通过潜在接收器的适当“输入”滤波器。
  - 只有当两个过滤器都接受公告时，它才会被传递到“最佳路径选择”过程。
  - 最后，它可能会进入接收器的 Loc-RIB。

当我们谈论“适当的”过滤器时，必须同时考虑路线的播音员和接收者。假设路由服务器收到来自客户端 A 的公告，并且路由服务器正在考虑将其用于客户端 B 的 Loc-RIB。应该应用的过滤器与全网状场景中使用的过滤器相同，即首先路由器 A 的“Out”过滤器用于发送到路由器 B 的公告，然后路由器 B 的“In”过滤器用于来自路由器 A 的公告。

如果没有路由服务器，我们将 RS 客户端的“导出策略”称为客户端将使用的一组“输出”过滤器。如果没有路由服务器，这同样适用于 RS 客户端的“导入策略”和客户端的“输入”过滤器集。

要求路由服务器不修改某些 BGP 属性（下一跳、作为路径和 MED）的情况也很常见，这些属性通常由标准 BGP 扬声器在宣布路由之前修改。

Quagga 实现的通知处理模型[如图 12.2](https://www.quagga.net/docs/docs-multi/Description-of-the-Route-Server-model.html#fig_003ars_002dprocessing)所示 。该图显示了 RS 客户端（B、C 和 D）与普通 BGP 对等体 (A) 的混合。有一些细节值得补充评论：

- 来自普通 BGP 对等体的公告也被考虑用于所有 RS 客户端的 Loc-RIB。但从逻辑上讲，它们不会通过任何出口政策。
- 那些配置为 RS 客户端的对等点不会收到来自“主”Loc-RIB 的任何通知。
- 除了导入和导出策略，还可以为 RS 客户端设置“输入”和“输出”过滤器。当路由服务器也有正常的 BGP 对等体时，'In' 过滤器可能很有用。另一方面，RS 客户端的“Out”过滤器可能是不必要的，但我们决定不删除它们，因为它们不会伤害任何人（它们总是可以留空）。