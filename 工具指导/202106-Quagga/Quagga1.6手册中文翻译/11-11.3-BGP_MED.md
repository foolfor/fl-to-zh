## 11.3 BGP MED

BGP MED (Multi_Exit_Discriminator) 属性具有可能导致 BGP 中细微收敛问题的属性。这些特性和问题已被证明是难以理解的，至少在历史上是这样，并且可能仍然没有被广泛理解。以下尝试收集并展示有关 MED 的知识，以帮助运营商和 Quagga 用户设计和配置他们的网络。

BGP MED (Multi_Exit_Discriminator) 属性旨在允许一个 AS 指示其对另一个 AS 的入口点的偏好。MED 属性不会被接收 AS 传播到另一个 AS - 它在 BGP 意义上是“不可传递的”。

例如，如果 AS X 和 AS Y 有 2 个不同的 BGP 对等点，那么 AS X 可能会在一个通告的路由上设置 MED 为 100，而在另一个通告路由的 MED 设置为 200。当 AS Y 在去往或通过 AS X 的其他相同路由之间进行选择时，AS Y 应该更喜欢通过与 AS X 100 的较低 MED 对等互连的路径。设置 MED 允许 AS 影响在另一个相邻的路由作为。

在 MED 的这种使用中，比较路径上下一个 AS 不同的路由上的 MED 值并没有真正意义。例如，如果除了来自 AS X 的路由之外，AS Y 还有通过 AS Z 到达某个目的地的路由，并且 AS Z 也设置了 MED，那么 AS Y 将 AS Z 的 MED 值与那些值进行比较是没有意义的AS X 的 MED 值由不同的管理员设置，具有不同的参考框架。

因此，BGP 的默认行为是不比较从不同相邻 AS 接收的路由之间的 MED 值。在 Quagga 中，这是通过比较收到的路由的 AS_PATH 中相邻的、最左侧的 AS 并仅比较 MED（如果它们相同）来完成的。

不幸的是，根据其他路由的属性，MED 的这种行为有时会跨路由进行比较，有时不会进行比较，这意味着 MED 可能导致所有路由的优先级顺序未定义。也就是说，给定路由 A、B 和 C，如果 A 优先于 B，而 B 优先于 C，那么明确定义的顺序应该意味着优先级是可传递的（在顺序[2](https://www.quagga.net/docs/docs-multi/BGP-MED.html#FOOT2)的意义上）并且 A 将优先于C。

然而，当涉及 MED 时，情况并非如此。使用 MED 时，C 实际上可能比 A 更受欢迎。所以 A 比 B 更受欢迎，B 比 C 更受欢迎，但 C 比 A 更受欢迎。即使 BGP 定义了一个确定性的“最优选”路由全套 A,B,C。使用 MED，对于任何给定的路由集，都可能有一个确定性的首选路由，但不需要以任何方式将它们排列成任何优先顺序。使用未修改的 MED，路由的优先顺序实际上变得未定义。

MED 可以引起对路线的非传递性偏好可能会导致问题。首先，它可能会导致扬声器本地的路由表混乱；其次，更严重的是，它可能导致 iBGP 拓扑中的路由不稳定，其中扬声器组在不同路径之间不断振荡。

第一个问题来自演讲者通常如何实施路由决策。尽管 BGP 定义了一个选择过程，它将在任何给定的说话者处确定性地选择相同的最佳路由，即使使用 MED，该过程也需要一起评估所有路由。出于性能和易于实现的原因，许多实现以成对的方式评估路由偏好。鉴于涉及 MED 时没有明确定义的顺序，将选择的最佳路由取决于实现细节，例如存储路由的顺序。这可能是（本地）不确定的，例如它可能是接收路由的顺序。

这种不确定性可能被认为是不受欢迎的，尽管它不一定会引起问题。这可能意味着会感知到额外的路由流失，因为有时会产生比其他时间更多的更新以响应某些事件。

第一个问题可以通过更具确定性的路由选择来解决，以确保路由在选择期间由相邻 AS 进行排序。请参阅[bgp 确定性医学](https://www.quagga.net/docs/docs-multi/BGP-MED.html#bgp-deterministic_002dmed)。这可能会减少收到路由时的更新次数，并且在某些情况下可能会减少路由流失。但是，它可以同样确定地产生最大可能的更新集以响应最常见的接收更新序列。

确定性的评估顺序往往意味着对到达目的地的任何 n 组路由进行排序的额外开销。Quagga 中确定性 MED 的实现比目前大多数排序算法要差得多，与给定目的地的路径数量相比。这个数字通常足够低，不会引起任何问题，但是在有很多路径的情况下，确定性比较可能会很快变得越来越昂贵的 CPU。

当地确定性评价，可以*不*固定MED的第二，更主要的，但是问题。也就是说，MED 路由的非传递性偏好可能会导致 iBGP 拓扑中跨多个扬声器的路由不稳定或振荡。这可能发生在全网状 iBGP 中，但在非全网状 iBGP 拓扑中尤其成问题，因为这些拓扑进一步减少了每个发言者已知的路由信息。这主要通过 iBGP 路由反射拓扑进行了记录。然而，任何路线隐藏技术也可能会加剧 MED 的振荡。

第二个问题发生在每个发言者只有一个路由子集的情况下，并且不同路由组合之间的偏好存在循环 - 正如 MED 的未定义优先顺序所允许的 - 并且路由的分布方式导致 BGP 发言者“追逐”那些周期。即使所有说话者都在路线选择中使用确定性的评估顺序，也会发生这种情况。

例如，AS A 中的扬声器 4 可能会收到来自 AS X 中扬声器 2 和 AS Y 中扬声器 3 的路由；而 AS A 中的扬声器 5 可能会从 AS Y 中的扬声器 1 接收该路由。AS Y 可能将扬声器 1 的 MED 设置为 200，扬声器 3 的 MED 设置为 100。即，使用 ASN:ID:MED 来标记扬声器：

```shell
           /---------------\
 X:2------|--A:4-------A:5--|-Y:1:200
 Y:3:100--|-/               |
           \---------------/
```



假设所有其他指标都相等（AS_PATH、ORIGIN、0 IGP 成本），那么根据 RFC4271 决策过程，演讲者 4 将根据较低的 ID 2 选择 X:2 而不是 Y:3:100。演讲者 4 宣传 X： 2 到演讲者 5。演讲者 5 将继续根据 ID 选择 Y:1:200，并将其通告给演讲者 4。演讲者 4 现在将拥有完整的路由集，并且它从 5 接收到的 Y:1:200将击败 X:2，但是当扬声器 4 将 Y:1:200 与 Y:3:100 进行比较时，MED 检查现在随着 ASes 匹配而激活，现在 Y:3:100 是首选。因此，演讲者 4 现在将 Y:3:100 通告给 5，这也将同意 Y:3:100 优先于 Y:1:200，因此从 4 撤回后一条路线。演讲者 4 现在只有 X:2 和Y:3:100，X:2 击败 Y:3:100，因此扬声器 4 隐式地将其到扬声器 5 的路由更新为 X:2。发言者 5 看到 Y:1：

根本原因是由于 MED 有时是有时不比较的方式导致缺乏明确的偏好顺序，导致路由之间的偏好出现这种循环：

```shell
       /---> X:2 ---beats---> Y:3:100 --\
      |                                  |
      |                                  |
       \---beats--- Y:1:200 <---beats---/
```

全网状 iBGP 拓扑中的这种特殊类型的振荡可以通过说话者更喜欢已经选择的外部路由而不是选择基于后 MED 度量（例如路由器 ID）更新到新路由来避免，代价是非确定性选择过程。Quagga 实现了这一点，就像许多其他实现一样，只要它不被设置[bgp bestpath compare-routerid 覆盖](https://www.quagga.net/docs/docs-multi/BGP-decision-process.html#bgp-bestpath-compare_002drouterid)，另见 [BGP 决策过程](https://www.quagga.net/docs/docs-multi/BGP-decision-process.html#BGP-decision-process)，。

然而，使用 iBGP 路由反射可能会出现更复杂和潜在的振荡循环，而这些循环并不那么容易避免。这些在不同的地方都有记载。参见，例如McPherson, D. 和 Gill, V. 和 Walton, D.，“Border Gateway Protocol (BGP) Persistent Route Oscillation Condition”，IETF RFC3345，以及Flavel, A. 和 M. Roughan，“稳定和灵活的 iBGP ”，ACM SIGCOMM 2009以及Griffin, T. 和 G. Wilfong，“关于 IBGP 配置的正确性”，ACM SIGCOMM 2002中的具体示例和进一步参考。

在撰写本文时，还*没有*已知的方法可以将 MED 用于其原始目的。*并*减少 iBGP 拓扑中的路由信息； *并且*一定要避免 MED 的不稳定问题，因为它可能会引起非传递性路由偏好；通常在任意网络上。

可能有 iBGP 拓扑特定的方法来降低不稳定风险，即使在使用 MED 时，例如通过约束反射拓扑和通过调整路由反射器集群之间的 IGP 成本，请参阅 RFC3345 了解详细信息。在不久的将来，BGP 的 Add-Path 扩展还可以通过分配“每个邻居 AS 的最佳路径”来解决 MED 振荡，同时仍允许按预期使用 MED。这将以向所有扬声器分配至少与全网状 iBGP 一样多的路由为代价，如果不是更多，同时还会在每个添加路径反射器上施加与“确定性 MED”功能类似的 CPU 开销。

更一般地说，MED 可能在更复杂的非全网状 iBGP 拓扑上引入的不稳定性问题可以通过以下方式避免：

- 设置[bgp always-compare-med](https://www.quagga.net/docs/docs-multi/BGP-MED.html#bgp-always_002dcompare_002dmed)，但是这允许跨不同邻居 AS 设置的值比较 MED，这可能不会产生一致的理想结果。
- 通过在所有接收到的路由上使用[routemap set metric](https://www.quagga.net/docs/docs-multi/Route-Map-Set-Command.html#routemap-set-metric)将 MED 设置为相同的值（例如 0），并结合在所有扬声器上设置[bgp always-compare-med](https://www.quagga.net/docs/docs-multi/BGP-MED.html#bgp-always_002dcompare_002dmed)，有效地忽略 MED 。这是避免 MED 振荡问题的最简单和最高效的方法，其中 AS 很高兴不允许邻居注入这个有问题的度量。

由于在 AS_PATH 长度检查之后评估 MED，因此 MED 的另一个可能用途是对具有相同 AS_PATH 长度的路由进行 AS 内导向，作为上述最后一种情况的扩展。由于在 IGP 度量之前评估 MED，这可以允许实施冷土豆路由以将流量发送到与邻居的首选切换，而不是根据 IGP 度量的最近切换。

请注意，即使采取措施解决 MED 非传递性问题，其他振荡仍可能存在。例如，如果 iBGP 和 IGP 拓扑相互交叉，则 IGP 成本 - 请参阅上面的 Flavel 和 Roughan 论文以获取示例。因此，iBGP 拓扑应遵循 IGP 拓扑的准则。

```shell
BGP: bgp deterministic-med
```

以在本地产生确定性答案的方式进行路线选择，即使面对 MED 和缺乏明确定义的优先顺序，它也可以在路线上引起。如果没有这个选项，带有 MED 的首选路由可能主要由接收路由的顺序决定。

当每个目的地有许多路由时，设置此选项会产生明显的性能成本。目前在 Quagga 中，它的实施方式随着每个目的地的路线数量增加而难以扩展。

默认是未设置此选项。

请注意，路由选择过程中还有其他不确定性来源，特别是对来自 eBGP 对等方的旧路由和已选择路由的偏好，请参阅[BGP 决策过程](https://www.quagga.net/docs/docs-multi/BGP-decision-process.html#BGP-decision-process)。

```shell
BGP: bgp always-compare-med
```

始终比较路由上的 MED，即使它们是从不同的相邻 AS 接收的。设置此选项可以更明确地定义路由的优先顺序，并且应该消除 MED 引起的振荡。

如果使用此选项，还可能需要使用[routemap set metric](https://www.quagga.net/docs/docs-multi/Route-Map-Set-Command.html#routemap-set-metric)将来自外部邻居的路由上的 MED 设置为 0。

该选项可以与[routemap set metric](https://www.quagga.net/docs/docs-multi/Route-Map-Set-Command.html#routemap-set-metric)一起使用，以将 MED 用作 AS 内的度量，以将等长的 AS_PATH 路由引导到，例如，所需的出口点。

> 提示<sub>(2)</sub>

> 对于具有顺序的某些对象集，*必须*为这些对象的*每个*组合定义某种二元排序关系，并且该关系*必须* 是可传递的。即，如果关系运算符是*â??º*，并且如果 a *â??º* b 和 b *â??º* c 则该关系必须延续，并且*必须*是 a *??º* c 对象才能具有命令。排序关系可以允许相等，即 a *??º* b 和 b *??º*a 可能都为真，并且暗示 a 和 b 在顺序上是相等的，而不是通过顺序来区分的，在这种情况下，集合具有偏序。否则，如果存在顺序，则所有对象在顺序中都有一个不同的位置，并且集合具有总顺序。